---
title: "Increased rate of large vessel occlusive stroke following the Christchurch terror attack"
shorttitle: "Terror attack stroke"

author: 
  - name          : "Teddy Wu, MD, FRACP"
    affiliation   : "1"
    corresponding : yes    # Define only one corresponding author
    address       : "66 Stewart St, Christchurch 8011, New Zealand"
    email         : "Teddy.Wu@cdhb.health.nz"
  - name          : "Daniel J. Myall, PhD"
    affiliation   : "1"
  - name          : "Campbell Le Heron, PhD, MD, FRACP"
    affiliation   : "1,2"
affiliation:
  - id            : "1"
    institution   : "Department of Neurology, Christchurch Hospital, Christchurch, New Zealand"
  - id            : "2"
    institution   : "New Zealand Brain Research Institute, 66 Stewart St, Christchurch, New Zealand"

csl: format/sage-vancouver.csl
bibliography: format/selected_refs.bib
abstract: |
  **Abstract:** Abstract goes here

keywords          : "Stroke, terror attack"
wordcount         : "Abstract: xx, main body: xx"

floatsintext      : no
figurelist        : no
tablelist         : no
footnotelist      : no
linenumbers       : yes
mask              : no
draft             : no

documentclass     : "apa6"
classoption       : "man"
output            : papaja::apa6_word
---

```{r setup, include=FALSE}
###########################################################################
# The papaja package is used to format the resulting manuscript.
# It is not currently available on CRAN, so install from GitHub using devtools:
#
# install.packages('devtools')
# devtools::install_github('crsh/papaja')
#
# devtools::install_github("hrbrmstr/hrbrthemes")
###########################################################################
library(papaja)

knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE,
	dpi = 600 # for reasonable dpi in Word document bitmap figures
)

# allow complex kableExtra features to render in Word:
options(kableExtra.auto_format = FALSE)
```

```{r control}
rstan::rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())

###########################################################################
# fitting the models takes time, so set this variable to FALSE to allow 
# reading previously-fit models that have been saved to disk. THESE MODELS
# ARE NOT NECESSARILY PLATFORM-AGNOSTIC, SO THEY MAY NEED TO BE RECALCULATED 
# THE FIRST TIME THIS SCRIPT IS RUN ON A NEW COMPUTER:
RECALCULATE_MODELS = FALSE
###########################################################################

```

```{r import-packages, message=FALSE}
# currently need to suppress messages in this block as the tidyverse import 
# produces tick marks that throw off the latex rendering:
suppressMessages(library(tidyverse))
library(magrittr)   # for %<>%
library(knitr)      # for kable() function to format tables
library(kableExtra) # additional table formatting options
library(lubridate)  # manipulate dates
library(glue)       # construct formatted strings (neater than paste)
library(janitor)    # clean column names
library(brms)       # bayesian modelling
library(ggeffects)  # for visualising model predictions
library(ggsci)      # scale_fill_npg
library(cowplot)    # construct multi-panel figures
library(hrbrthemes)   # Fonts
library(scales)   # pretty_breaks()
library(forcats)  # recode()
library(broom)    # broom()

```


```{r define-variables}
# how many iterations to use in the model fitting.
N_ITERATIONS = 5000

# specify manual colour scheme:
two_colours = c('#BBBBBB', '#DD0000')

ndigits <- function(number, digits = 1){
  return(format(round(number, digits = digits), nsmall = digits))
}

```

```{r import-data}

vars = c('Admissions','Reperfusion','Thrombolysis','LVO','Thrombectomy')
missing_national_vars = c('Thrombolysis','LVO','Thrombectomy')

regions = c('Christchurch','National')

dat_local <- read.csv("data/christchurch_strokes.csv") %>%
  mutate(Week = Week - 64, # Make relative to week of terror attack
         area = 'Christchurch') 
  
dat_national <- read.csv("data/national_strokes.csv") %>%
  mutate(Week = Week - 64, # Make relative to week of terror attack
         area = 'National')

dat_all <- dat_local %>%
  bind_rows(dat_national) %>%
  gather(var,count,Reperfusion,Admissions,Thrombolysis,LVO,Thrombectomy)

dat_demo <- read.csv("data/demographics.csv")


```


```{r fit-or-load-models, echo=FALSE, message=FALSE, warning=FALSE}
# decide whether to fit models from scratch, or save execution time by reloading
# models saved to disk previously:
if (RECALCULATE_MODELS) {

  # fit the models from scratch and save them to disk:
  for (region in regions) {
    
    for (variable in vars) {
      
      # model for assessing effect of terror attack on stroke measure:
      if (!(region == 'National' & variable %in% missing_national_vars)) {
        model = brm(data = dat_all %>% 
                      filter(var == variable) %>%
                      filter(area == region), 
                    count ~ effect, 
                    family = poisson(),
                    iter = N_ITERATIONS, 
                    sample_prior = TRUE)
        
        saveRDS(model, glue('models/brm_{region}_{variable}.rds'))
      }
    }
  
  }
}

# regardless, now read in the previously-fitted models from disk.
for (region in regions) {
  for (variable in vars) {
    if (!(region == 'National' & variable %in% missing_national_vars)) {

      model_name = glue('brm_{region}_{variable}')
        
      # read its saved representation from disk:
      model = readRDS(glue('models/{model_name}.rds'))
      
      # assign to a variable with the associated name:
      assign(model_name, model)
    }
  }
}

```


```{r demographics, echo=FALSE}

N_admissions_christchurch = dat_demo %>%
  filter(region == 'Christchurch',variable =='Admissions') %>%
  count()

N_repurfusions_christchurch = dat_demo %>%
  filter(region == 'Christchurch',variable =='Repurfusion') %>%
  count()

N_repurfusion_percent = N_repurfusions_christchurch/N_admissions_christchurch

# Don't currently have variable to calculate this from raw data
N_imaging_christchurch = 399

N_imaging_percent = N_imaging_christchurch/N_admissions_christchurch

N_LVO_christchurch = dat_demo %>%
  filter(region == 'Christchurch',variable =='LVO') %>%
  count()

N_LVO_imaging_percent = N_LVO_christchurch/N_imaging_christchurch

mean_ages <- dat_demo %>%
  filter(region == 'Christchurch') %>%
  group_by(variable,effect) %>%
  summarise(mean(age)) 
  
mean_ages_p <- dat_demo %>% 
  filter(region == 'Christchurch') %>%
  group_by(variable) %>%
  do(tidy(t.test(age ~ effect, data = .)))

mean_sex <- dat_demo %>%
  filter(region == 'Christchurch') %>%
  group_by(variable,effect) %>%
  summarise(mean(sex == 'Male')) 

mean_sex_p <- dat_demo %>% 
  filter(region == 'Christchurch') %>%
  group_by(variable) %>%
  do(tidy(t.test(sex == 'Male' ~ effect, data = .)))

mean_af <- dat_demo %>%
  filter(region == 'Christchurch') %>%
  group_by(variable,effect) %>%
  summarise(mean(atrial_fibrillation == 'Yes')) 

mean_af_p <- dat_demo %>% 
  filter(region == 'Christchurch') %>%
  group_by(variable) %>%
  do(tidy(t.test(atrial_fibrillation == 'Yes' ~ effect, data = .)))


```


```{r terror-attack-effects}

# What is the probability that there were was an effect on the measure following the terror attack

# Christchurch data
p_Christchurch_Admissions_terror  = 
  brms::hypothesis(brm_Christchurch_Admissions, 'effectterror > 0')$hypothesis$Post.Prob*100
p_Christchurch_Reperfusion_terror  = 
  brms::hypothesis(brm_Christchurch_Reperfusion, 'effectterror > 0')$hypothesis$Post.Prob*100
p_Christchurch_LVO_terror  = 
  brms::hypothesis(brm_Christchurch_LVO, 'effectterror > 0')$hypothesis$Post.Prob*100
p_Christchurch_Thrombectomy_terror  = 
  brms::hypothesis(brm_Christchurch_Thrombectomy, 'effectterror > 0')$hypothesis$Post.Prob*100
p_Christchurch_Thrombolysis_terror  = 
  brms::hypothesis(brm_Christchurch_Thrombolysis, 'effectterror > 0')$hypothesis$Post.Prob*100

Christchurch_admissions_coefs = fixef(brm_Christchurch_Admissions)
Christchurch_Reperfusion_coefs = fixef(brm_Christchurch_Reperfusion)
Christchurch_LVO_coefs = fixef(brm_Christchurch_LVO)
Christchurch_Thrombectomy_coefs = fixef(brm_Christchurch_Thrombectomy)
Christchurch_Thrombolysis_coefs = fixef(brm_Christchurch_Thrombolysis)

# Compare to national data
p_national_Admissions_terror  = 
  brms::hypothesis(brm_National_Admissions, 'effectterror > 0')$hypothesis$Post.Prob*100
p_national_Reperfusion_terror  = 
  brms::hypothesis(brm_National_Reperfusion, 'effectterror > 0')$hypothesis$Post.Prob*100

national_admissions_coefs = fixef(brm_National_Admissions)
national_Reperfusion_coefs = fixef(brm_National_Reperfusion)

```


# Introduction

# Methods

## Sample
Christchurch hospital admits all people with stroke in Christchurch a city of 390 000, and provides endovascular thrombectomy for the South Island of New Zealand, population 4.8 million. Counts of ischemic stroke admissions, the numbers of patients with intracranial LVO, and the numbers who underwent reperfusion therapy (intravenous thrombolysis and/or endovascular thrombectomy) were collected for the week following the terror attack and from 1st January 2018 until 21st April 2019. These counts were repeated for the rest of New Zealand with the Christchurch data omitted. 
 
## Analyses
Data for each measure, and by Christchurch and nationally, were fit with Bayesian Poisson models, using the R[@rdevelopmentcoreteam2019_LanguageEnvironmentStatistical] package _brms_. [@burkner2017_BrmsPackageBayesian] Parameters were given default weakly-informative priors. Four chains of 5000 iterations each were run. The probability of the rate observed in the week following the terror attack being higher than the background rate was calculated for each measure, with a probability higher than 0.99 providing strong evidence of an effect. 

## Reproducibility
The code and the anonymised dataset used to conduct the analyses and generate this manuscript are available at https://github.com/nzbri/terror-attack-stroke.

# Results
In the week following the 15th March 2019 terror attack there was no evidence of difference in the number of ischemic stroke admissions (Figure 1 top left, mean rate = `r ndigits(exp(Christchurch_admissions_coefs['Intercept','Estimate']),0)`, probability of an increse after the terror attack P = `r ndigits(p_Christchurch_Admissions_terror, 0)`%), but an increase in those receiving reperfusion therapy (Figure 1 bottom left, mean rate= `r ndigits(exp(Christchurch_Reperfusion_coefs['Intercept','Estimate']))`, probability P = `r ndigits(p_Christchurch_Reperfusion_terror, 1)`%). Over the same periods in the rest of New Zealand, there was no evidence of a difference in the number of ischemic stroke admissions (Figure 1 top right, mean rate = `r ndigits(exp(national_admissions_coefs['Intercept','Estimate']),0)`, P = `r ndigits(p_national_Admissions_terror, 0)`%) nor strong evidence of an increase in the numbers of people treated with reperfusion treatments (Figure 1 bottom left, mean rate= `r ndigits(exp(national_Reperfusion_coefs['Intercept','Estimate']),0)`, P = `r ndigits(p_national_Reperfusion_terror, 0)`%).

Examining the type of strokes, in Christchurch there was an increase in the number of patients with Thrombectomys (Figure 2, left, mean rate = `r ndigits(exp(Christchurch_Thrombectomy_coefs['Intercept','Estimate']))`, P = `r ndigits(p_Christchurch_Thrombectomy_terror, 1)`%), intracranial LVOs (Figure 2 centre, mean rate = `r ndigits(exp(Christchurch_LVO_coefs['Intercept','Estimate']))`, P = `r ndigits(p_Christchurch_LVO_terror, 1)`%), and Thrombolysis strokes (Figure 2 right, mean rate = `r ndigits(exp(Christchurch_Thrombolysis_coefs['Intercept','Estimate']))`, P = `r ndigits(p_Christchurch_Thrombolysis_terror, 1)`%).

# Discusion

# Figure National


```{r main-figure, fig.width = 18/2.54, fig.height = 13/2.54, fig.cap="Number of stroke admissions (top row) and stroke reperfusions (bottom row) per week for Christchurch Hospital and nationally (excluding Christchurch Hospital). The week starting on Monday, following the stroke attack, is highlighted as week 0. The average number of admissions or strokes per week is shown by the black horizontal line. Figure by Myall (2020), distributed at https://doi.org/10.6084/xx under an open CC-BY 4.0 license.", dev='png', dev.args=list(type='cairo')}

dat_mean_rate_admissions <- data.frame(area = c('National','Christchurch'),
                    rate = c(exp(national_admissions_coefs['Intercept','Estimate']),
                             exp(Christchurch_admissions_coefs['Intercept','Estimate'])
                    )
)

dat_mean_rate_repurfusion <- data.frame(area = c('National','Christchurch'),
                    rate = c(exp(national_Reperfusion_coefs['Intercept','Estimate']),
                             exp(Christchurch_Reperfusion_coefs['Intercept','Estimate'])
                             
                    )
)

dat_figure_1a <- dat_all %>%
  filter(var %in% c('Admissions'))

figure_1a = ggplot(dat_figure_1a,aes(y=count,x=Week,fill=effect))+
  geom_bar(stat="identity")+ylab("Number of stroke admissions per week")+
  geom_hline(data = dat_mean_rate_admissions, aes(yintercept = rate))+
  xlab("Weeks relative to terror attack")+
  facet_wrap(~area,scales = "free_y")+
  scale_fill_manual(values=two_colours)+
  scale_y_continuous(breaks= pretty_breaks())+
  theme_ipsum()+
  theme(legend.position="none",
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        plot.margin = unit(c(0, 0, 0, 0), "cm"))

dat_figure_1b <- dat_all %>%
  filter(var %in% c('Reperfusion'))

figure_1b = ggplot(dat_figure_1b,aes(y=count,x=Week,fill=effect))+
  geom_bar(stat="identity")+ylab("Number of stroke reperfusions per week")+
  geom_hline(data = dat_mean_rate_repurfusion, aes(yintercept = rate))+
  xlab("Weeks relative to terror attack")+
  facet_wrap(~area,scales = "free_y")+
  scale_fill_manual(values=two_colours)+
  scale_y_continuous(breaks= pretty_breaks())+
  theme_ipsum()+
  theme(legend.position="none",
        plot.margin = unit(c(0, 0, 0, 0), "cm"))

figure_1 = cowplot::plot_grid(figure_1a, figure_1b, 
                              align = 'v',
                              axis = 'bt', ncol = 1)

print(figure_1)

ggsave(plot = figure_1, 
       filename = 'figures/Figure_1.pdf', width = 18, height = 13, 
       units = 'cm', device = cairo_pdf,)

ggsave(plot = figure_1, 
       filename = 'figures/Figure_1.png', width = 18, height = 13, 
       units = 'cm', dpi = 600, type = 'cairo')

```


```{r stroke-type-figure, fig.width = 18/2.54, fig.height = 7/2.54, fig.cap="Number of strokes per week by type at Christchurch Hospital, with the week starting on Monday following the terror attack highlighted at week 0. The average number of strokes per week is shown by the black horizontal line. Figure by Myall (2020), distributed at https://doi.org/10.6084/xx under an open CC-BY 4.0 license.", dev='png', dev.args=list(type='cairo')}

dat_figure_2 <- dat_all %>%
  filter(var %in% c('Thrombolysis','LVO','Thrombectomy')) %>%
  mutate(var = recode(var, LVO = "Large vessel occlusion"))

dat_mean_rate <- data.frame(var = c('Thrombolysis','Large vessel occlusion','Thrombectomy'),
                    rate = c(exp(Christchurch_Thrombolysis_coefs['Intercept','Estimate']),
                             exp(Christchurch_LVO_coefs['Intercept','Estimate']),
                             exp(Christchurch_Thrombectomy_coefs['Intercept','Estimate'])
                    )
)

figure_2 = ggplot(dat_figure_2,aes(y=count,x=Week,fill=effect))+
  geom_bar(stat="identity")+ylab("Number of strokes per week")+
  geom_hline(data = dat_mean_rate, aes(yintercept = rate))+
  xlab("Weeks relative to terror attack")+
  facet_wrap(~var)+#,scales = "free_y")+
  #scale_y_continuous(breaks=seq(0,10,2))+
  scale_y_continuous(breaks= pretty_breaks())+
  scale_fill_manual(values=two_colours)+
  theme_ipsum()+
  theme(legend.position="none",
        plot.margin = unit(c(0, 0, 0, 0), "cm"))


print(figure_2)

ggsave(plot = figure_2, 
       filename = 'figures/Figure_2.pdf', width = 18, height = 7, 
       units = 'cm', device = cairo_pdf,)

ggsave(plot = figure_2, 
       filename = 'figures/Figure_2.png', width = 18, height = 7, 
       units = 'cm', dpi = 600, type = 'cairo')

```


# References



